close all
clear
clc

%% Linearized ROV Model (EVA)
% Realized with the "Linear Analysis Toolbox" (see 'linsys.mat')
A = [-0.5423,             0,             0,             0,             0,               0,             0,             0,             0,             0,        0.3395,             0;
           0,        -1.071,             0,             0,             0,               0,             0,             0,             0,       -0.3173,             0,             0;
           0,             0,        -2.219,             0,             0,               0,             0,             0,             0,             0,             0,             0;
           0,             0,             0,       -0.1154,     -0.005623,       -0.007386,             0,             0,             0,        -8.357,       -0.4071,             0;
           0,             0,             0,     -0.005623,      -0.06863,       -0.001323,             0,             0,             0,       -0.4071,        -4.969,             0;
           0,             0,             0,     -0.007386,     -0.001323,        -0.06602,             0,             0,             0,       -0.5347,      -0.09577,             0;
           1,             0,             0,             0,             0,               0,             0,             0,             0,             0,             0,             0;
           0,             1,             0,             0,             0,               0,             0,             0,             0,             0,             0,             0;
           0,             0,             1,             0,             0,               0,             0,             0,             0,             0,             0,             0;
           0,             0,             0,             1,             0,               0,             0,             0,             0,             0,             0,             0;
           0,             0,             0,             0,             1,               0,             0,             0,             0,             0,             0,             0;
           0,             0,             0,             0,             0,               1,             0,             0,             0,             0,             0,             0];

B = [0.05581,         0,         0,         0,         0,         0;
           0,   0.05217,         0,         0,         0,         0;
           0,         0,   0.03223,         0,         0,         0;
           0,         0,         0,     1.649,   0.08033,    0.1055;
           0,         0,         0,   0.08033,    0.9804,    0.0189;
           0,         0,         0,    0.1055,    0.0189,    0.9431;
           0,         0,         0,         0,         0,         0;
           0,         0,         0,         0,         0,         0;
           0,         0,         0,         0,         0,         0;
           0,         0,         0,         0,         0,         0;
           0,         0,         0,         0,         0,         0;
           0,         0,         0,         0,         0,         0;];

C = eye(12);
D = zeros(12,6);

% Initial condition
x0 = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]';

%% LQR Design
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% Version 1 %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% % Controllability & Observability
% rc = rank(ctrb(A,B));
% ro = rank(obsv(A,C));
%  
% Q = diag([200,200,200,400,400,400,200,200,200,400,400,400]); % (12x12)
% R = 0.5*eye(6); % (6x6)
% K = lqr(A,B,Q,R);
% 
% Kx = K(:,1:6);
% Kq = K(:,7:12);
% 
% save lqr Kq Kx

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% Version 2 %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
C = [zeros(6) eye(6)];
D = zeros(6,6);

% Augmented System
A_aug = [A zeros(12,6); -C zeros(6)];
B_aug = [B; zeros(6)];
C_aug = [C zeros(6)];
D_aug = D;

% Controllability & Observability
rc = rank(ctrb(A_aug,B_aug));

Q = 100*eye(18); % (18x18)
R = 0.5*eye(6); % (6x6)

Cq = chol(Q); % Choleski factor
ro = rank(obsv(A_aug,Cq));

K = lqr(A_aug,B_aug,Q,R);

Kx = K(:,1:12);
Kq = K(:,13:end);

sys_x = ss(A,B,eye(12),zeros(12,6));

save lqr Kq Kx

%% Simulation
sim_time = 100;
Ts = 0.01;
open('lqr_sim.slx')
% sim('lqr_sim.slx')